{% extends "web/base.html" %}
{% block content %}

<h1>Ventas</h1>

<section class="card">
  <h2>Filtros</h2>
  <form action="/web/ventas" method="get" class="form-grid">
    <label>Desde
      <input type="date" name="desde" value="{{ desde }}">
    </label>
    <label>Hasta
      <input type="date" name="hasta" value="{{ hasta }}">
    </label>

    <label>Producto
      <select name="producto_id">
        <option value="">Todos</option>
        {% for p in productos %}
          <option value="{{ p.id_producto }}" {% if producto_id == p.id_producto %}selected{% endif %}>{{ p.nombre }}</option>
        {% endfor %}
      </select>
    </label>

    <label>Usuario
      <select name="usuario_id">
        <option value="">Todos</option>
        {% for u in usuarios %}
          <option value="{{ u.id_usuario }}" {% if usuario_id == u.id_usuario %}selected{% endif %}>{{ u.nombre_usuario }}</option>
        {% endfor %}
      </select>
    </label>

    <button type="submit">Aplicar</button>
  </form>
</section>

<section class="kpis row" style="gap:1rem;">
  <div class="card">
    <div class="muted">Unidades vendidas</div>
    <div class="h4 mb-0">{{ resumen.get('total_unidades', 0) }}</div>
  </div>
  <div class="card">
    <div class="muted">Monto total ($)</div>
    <div class="h4 mb-0">{{ '%.2f'|format(resumen.get('monto_total', 0)) }}</div>
  </div>
  <div class="card">
    <div class="muted">Ticket promedio ($)</div>
    <div class="h4 mb-0">{{ '%.2f'|format(resumen.get('ticket_promedio', 0)) }}</div>
  </div>
</section>

<section class="card">
  <h2>Registrar venta</h2>
  <form action="/web/ventas" method="post" class="form-grid">
    <label>Usuario
      <select name="id_usuario" required>
        <option value="" disabled selected>Seleccione</option>
        {% for u in usuarios %}
          <option value="{{ u.id_usuario }}">{{ u.nombre_usuario }}</option>
        {% endfor %}
      </select>
    </label>

    <label>Producto
      <select name="id_producto" required>
        <option value="" disabled selected>Seleccione</option>
        {% for p in productos %}
          <option value="{{ p.id_producto }}">{{ p.nombre }}</option>
        {% endfor %}
      </select>
    </label>

    <label>Cantidad
      <input type="number" name="cantidad_vendida" required min="1" step="1">
    </label>

    <button type="submit">Registrar</button>
  </form>

  {% if msg %}
    <div class="alert" style="margin-top:.5rem">{{ msg }}</div>
  {% endif %}
</section>

<section class="card">
  <h2>Listado de ventas</h2>
  {% if ventas %}
  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Fecha</th><th>Usuario</th><th>Producto</th><th>Cantidad</th><th>Total ($)</th>
        </tr>
      </thead>
      <tbody>
      {% for v in ventas %}
        <tr>
          <td>{{ v.id_venta }}</td>
          <td>{{ v.fecha_venta.strftime('%Y-%m-%d %H:%M') if v.fecha_venta else '' }}</td>
          <td>{{ (map_user.get(v.id_usuario).nombre_usuario) if map_user.get(v.id_usuario) else v.id_usuario }}</td>
          <td>{{ (map_prod.get(v.id_producto).nombre) if map_prod.get(v.id_producto) else v.id_producto }}</td>
          <td>{{ v.cantidad_vendida }}</td>
          <td>{{ '%.2f'|format(v.total_venta or 0) }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p>No hay ventas para el filtro.</p>
  {% endif %}
</section>

{% endblock %}
